# @rollbar/api

This directory contains some rust code that can be compiled to both web assembly and a
native node module that a node program can use.

## Prerequisites

- [Install rust and it's toolchain.](https://rustup.rs/)
- [Install `wasm-pack`.](https://rustwasm.github.io/wasm-pack/installer/)

## Test it out

In the root directory of this repository, run either of the test commands.

```
make test-browser
make test-server
```

## Explanation of work

This is a minimal example of what moving logic into a rust package. It simply exports a single function: `parseUrl` which internally uses the [`url` crate (i.e. package/module).](https://github.com/servo/rust-url) This crate is probably used in Firefox as its maintained by the [servo team](https://serve.org), Mozilla's version of Google's Chromium browser engine that Chrome and other browsers use under the hood.

### Browser

`wasm-pack`'s ecosystem has a [webpack plugin](https://github.com/wasm-tool/wasm-pack-plugin) that manages compiling and bundling the rust and the generated glue code for use. Any user of this core module just needs consume the generated directory by importing it directly, adding it to the dependencies in a `package.json` file, or as a webpack alias [(my choice for this proof of concept).](../karma.conf.js#L91)

A caveat with how this package is set up, is that it needs to be imported lazily (e.g. `import('...').then`, not `require('') or import ... from ''`). This is because web assembly can't be included in an initial bundle. I don't have a complete understanding of this requirement to say if this is an ecosystem requirement or a webpack requirment.

The test where this library is loaded and then passed to the API object can be found [here.](../test/api.test.js#L31)

### Node

[`neon`](https://github.com/neon-bindings/neon) is a popular open source project used for managing bindings between rust and node's module system. A user of this core module needs to import the `index.node` module generated by `prebuild` script in the root project's `package.json`. Users of the rollbar library don't have to worry about it*.

* In the end this is true, but this POC doesn't copy that module file into the distributed directory yet.
